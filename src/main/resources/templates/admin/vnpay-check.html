<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" layout:decorate="~{admin/admin-layout.html}">

<head>
    <meta charset="utf-8">
    <title>VNPay Check</title>
</head>
<div layout:fragment="content">
    <div class="container" style="padding: 24px;">
        <h2>VNPay Check</h2>
        <div>
            <label>vnp_TmnCode:</label> <strong th:text="${tmnCode}"></strong>
        </div>
        <div>
            <label>vnp_PayUrl:</label> <strong th:text="${payUrl}"></strong>
        </div>
        <div style="margin-top: 18px;">
            <button id="checkBtn" class="btn">Run check</button>
            <button id="clearReturnUrlBtn" class="btn" style="margin-left:12px;">Clear saved return URL</button>
        </div>

        <pre id="resultBox"
            style="margin-top: 14px; white-space: pre-wrap; background:#f0f0f0; padding:12px; border-radius:6px; display:none;"></pre>
        <div id="summary" style="margin-top: 12px;"></div>
        <div id="actionPanel" style="margin-top: 12px; display:none; padding: 12px; border-radius: 4px;"></div>
    </div>
</div>

<script th:src="@{/vendor/jquery/jquery-3.2.1.min.js}"></script>
<script>
    document.getElementById('checkBtn').addEventListener('click', function () {
        const btn = this;
        btn.disabled = true;
        btn.textContent = 'Checking...';
        fetch('/api/admin/payment/check-vnpay')
            .then(res => res.json())
            .then(json => {
                document.getElementById('resultBox').style.display = 'block';
                document.getElementById('resultBox').textContent = JSON.stringify(json, null, 2);
                btn.disabled = false;
                btn.textContent = 'Run check';
                // show a short summary
                const summaryEl = document.getElementById('summary');
                const ok = json.testResponse && json.testResponse.ok;
                const notApproved = json.testResponse && json.testResponse.notApprovedDetected;
                summaryEl.innerHTML = `<b>Pay URL ok:</b> ${JSON.stringify(json.payUrlReachable)}<br>` +
                    `<b>Return URL ok:</b> ${JSON.stringify(json.returnUrlReachable)}<br>` +
                    `<b>Test call ok:</b> ${ok}<br>` +
                    `<b>Not approved detected:</b> ${notApproved}`;

                // Show next steps
                const actionPanel = document.getElementById('actionPanel');
                actionPanel.style.display = 'block';
                if (notApproved) {
                    actionPanel.style.background = '#ffe6e6';
                    actionPanel.style.border = '1px solid #ffb3b3';
                    actionPanel.innerHTML = `<b style='color: #d9534f'>VNPay trả về trạng thái 'không phê duyệt' hoặc code 71.</b><br/>` +
                        `Hành động đề xuất:<br/>` +
                        `<ol>` +
                        `<li>Kiểm tra <b>vnp_TmnCode</b> (TMN) trong cấu hình có chính xác không.</li>` +
                        `<li>Đảm bảo <b>vnp_ReturnUrl</b> đã được khai báo trong VNPay merchant portal.</li>` +
                        `<li>Đảm bảo bạn đang dùng <b>sandbox</b> credentials cho sandbox URL; dùng production keys cho production.</li>` +
                        `<li>Nếu cần test môi trường local, hãy sử dụng ngrok để tạo URL công khai và đăng kí URL đó trong VNPay portal.</li>` +
                        `<li>Nếu mọi thứ đúng, liên hệ VNPay và cung cấp mã TMN, vnp_ReturnUrl để họ phê duyệt sandbox.</li>` +
                        `</ol>`;
                } else if (!ok) {
                    actionPanel.style.background = '#fff3cd';
                    actionPanel.style.border = '1px solid #ffeeba';
                    actionPanel.innerHTML = `<b style='color: #856404'>Test request không thành công.</b><br/>` +
                        `Kiểm tra: cấu hình proxy, firewall, hoặc network để đảm bảo ứng dụng có thể truy cập VNPay sandbox URL.`;
                } else {
                    actionPanel.style.background = '#e8f8f5';
                    actionPanel.style.border = '1px solid #d6efe9';
                    actionPanel.innerHTML = `<b style='color: #1b6f59'>VNPay endpoint nhận request và không trả lỗi 'not approved'.</b><br/>` +
                        `Nếu người dùng vẫn gặp lỗi, kiểm tra TMN/secret hoặc contact VNPay.`;
                }
            })
            .catch(err => {
                document.getElementById('resultBox').style.display = 'block';
                document.getElementById('resultBox').textContent = 'Error: ' + err;
                btn.disabled = false;
                btn.textContent = 'Run check';
            });
    });

    $('#clearReturnUrlBtn').on('click', function () {
        if (confirm('Clear saved return URL?')) {
            try { localStorage.removeItem('vnp_returnUrlOverride'); alert('Saved return URL removed.'); } catch (e) { alert('Unable to clear saved URL.'); }
        }
    });
</script>
</body>

</html>