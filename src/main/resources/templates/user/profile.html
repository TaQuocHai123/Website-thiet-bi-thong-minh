<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{user/layout-user.html}">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        select.form-control {
            background-color: #fff !important;
            color: #000 !important;
        }
        select.form-control option {
            background-color: #fff !important;
            color: #000 !important;
        }
    </style>
</head>

<body>
    <div layout:fragment="content">
        <div class="custom-modal" id="add-address-modal"
            style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);">
            <div class="modal-content rounded"
                style="background-color: white; margin: 5% auto; padding: 20px; width: 95%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <span class="close" id="closeModal"
                    style="cursor: pointer; float: right; font-size: 28px; font-weight: bold; color: #aaa;">&times;</span>
                <div class="modal-header mb-3">
                    <h5 style="margin: 0;">Th√¥ng tin ƒë·ªãa ch·ªâ</h5>
                </div>
                <form id="address-form">
                    <div class="mb-3">
                        <input class="form-control" type="text" name="street" id="street"
                            placeholder="S·ªë nh√†, ƒë∆∞·ªùng, x√≥m">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">T·ªânh / Th√†nh ph·ªë:</label>
                        <select class="form-control" name="province" id="province" style="background-color: #fff !important; color: #000 !important;">
                            <option value="">-- Ch·ªçn t·ªânh --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Qu·∫≠n / Huy·ªán:</label>
                        <select class="form-control" name="district" id="district" style="background-color: #fff !important; color: #000 !important;">
                            <option value="">-- Ch·ªçn huy·ªán --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ph∆∞·ªùng / X√£:</label>
                        <select class="form-control" name="ward" id="ward" style="background-color: #fff !important; color: #000 !important;">
                            <option value="">-- Ch·ªçn x√£ --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <button type="button" id="pick-map-btn" class="btn btn-outline-secondary btn-sm">üìç Ch·ªçn v·ªã tr√≠
                            tr√™n b·∫£n ƒë·ªì</button>
                    </div>

                    <input type="hidden" id="latitude" />
                    <input type="hidden" id="longitude" />

                    <button type="button" class="btn btn-primary w-100" id="save-address-btn">L∆∞u</button>
                </form>
            </div>
        </div>

        <div class="d-flex flex-column w-100" style="background-color: rgb(249, 249, 249);">
            <div class="page-wrapper">
                <div class="d-flex justify-content-center">
                    <div class="page-right">
                        <h3 class="title">Qu·∫£n l√Ω t√†i kho·∫£n</h3>
                        <div>
                            <!-- Tab items -->
                            <div class="tab-bills">
                                <div class="tab-item active">
                                    Ch·ªânh s·ª≠a th√¥ng tin
                                </div>
                                <div class="tab-item">
                                    ƒê·ªïi m·∫≠t kh·∫©u
                                </div>
                                <div class="line"></div>
                            </div>

                            <!-- Tab content -->
                            <div class="tab-content">
                                <div class="tab-pane active">
                                    <form th:action="@{/update-profile}" method="post" id="profile-form">
                                        <h4 class="subtitle my-3">Th√¥ng tin c√° nh√¢n</h4>
                                        <div class="alert alert-success" th:if="${successMessage != null}"
                                            th:text="${successMessage}"></div>
                                        <div class="alert alert-danger" th:if="${errorMessage != null}"
                                            th:text="${errorMessage}"></div>
                                        <div class="row mt-3">
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="control-label">
                                                        H·ªç v√† t√™n
                                                    </label>
                                                    <input type="text" class="form-control" name="name" id="name"
                                                        th:value="${profile.name}">
                                                    <span class="error text-danger"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-sm-6">
                                                <label class="control-label">
                                                    Email
                                                </label>
                                                <input type="text" class="form-control" name="email"
                                                    th:value="${profile.email}" readonly>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label class="control-label">
                                                        S·ªë ƒëi·ªán tho·∫°i
                                                    </label>
                                                    <input type="text" class="form-control" id="phoneNumber"
                                                        th:value="${profile.phoneNumber}" name="phoneNumber">
                                                    <span class="error text-danger"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="btn-save-group">
                                            <button class="btn-save btn-save-profile">L∆∞u thay ƒë·ªïi</button>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-sm-12">
                                                <label class="control-label">
                                                    ƒê·ªãa ch·ªâ giao h√†ng
                                                </label>
                                                <div id="address-list">
                                                    <div th:each="address: ${profile.addressShippingList}">
                                                        <div class="d-flex align-items-center justify-content-between my-1"
                                                            th:attr="data-id=${address.id},data-lat=${address.latitude},data-lng=${address.longitude},data-province=${address.provinceId},data-district=${address.districtId},data-ward=${address.wardCode}">
                                                            <span>
                                                                <i class="fa fa-map-marker" aria-hidden="true"></i>
                                                                <span th:text="${address.address}"></span>
                                                            </span>
                                                            <span class="text-primary cursor-pointer edit-address-btn"
                                                                th:data-id="${address.id}" title="S·ª≠a ƒë·ªãa ch·ªâ">
                                                                <i class="fa fa-pencil" aria-hidden="true"></i>
                                                            </span>
                                                            <span class="text-danger cursor-pointer delete-address-btn"
                                                                th:address-id="${address.id}">
                                                                <i class="fa fa-trash-o" aria-hidden="true"></i>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-light" id="add-address"
                                                    onclick="openAddAddressModal()">Th√™m ƒë·ªãa ch·ªâ +</button>
                                            </div>
                                        </div>

                                    </form>
                                </div>
                                <div class="tab-pane">
                                    <form id="change-password-form" th:action="@{/change-password}" method="post">
                                        <h4 class="subtitle my-3">ƒê·ªïi m·∫≠t kh·∫©u</h4>
                                        <div class="row mt-3">
                                            <div class="col-sm-6">
                                                <label class="control-label">
                                                    M·∫≠t kh·∫©u hi·ªán t·∫°i
                                                </label>
                                                <div class="form-group">
                                                    <input type="password" class="form-control" id="currentPassword"
                                                        name="currentPassword">
                                                    <!--                                                <i class="fa-solid" style="margin: 10px 0 0 -30px; cursor: pointer;"-->
                                                    <!--                                                   [ngClass]="{'fa-eye': currentPasswordVisible, 'fa-eye-slash': !currentPasswordVisible }"-->
                                                    <!--                                                   (click)="togglePasswordVisibility()"></i>-->
                                                    <span class="error text-danger"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-sm-6">
                                                <label class="control-label">
                                                    M·∫≠t kh·∫©u m·ªõi
                                                </label>
                                                <!--                                            <span class="red_require"> *</span>-->
                                                <div class="form-group">
                                                    <input type="password" class="form-control" id="newPassword"
                                                        name="newPassword">
                                                    <!--                                                <i class="fa-solid" style="margin: 10px 0 0 -30px; cursor: pointer;"-->
                                                    <!--                                                   [ngClass]="{'fa-eye': newPasswordVisible, 'fa-eye-slash': !newPasswordVisible }"-->
                                                    <!--                                                   (click)="toggleNewPasswordVisibility()"></i>-->
                                                    <span class="error text-danger"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-sm-6">
                                                <label class="control-label">
                                                    X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi
                                                </label>
                                                <div class="form-group">
                                                    <input type="password" class="form-control" id="confirmPassword"
                                                        name="confirmPassword">
                                                    <!--                                                <i class="fa-solid" style="margin: 10px 0 0 -30px; cursor: pointer;"-->
                                                    <!--                                                   [ngClass]="{'fa-eye': confirmPasswordVisible, 'fa-eye-slash': !confirmPasswordVisible }"-->
                                                    <!--                                                   (click)="toggleConfirmPasswordVisibility()"></i>-->
                                                    <span class="error text-danger"></span>

                                                </div>
                                            </div>
                                            <div class="btn-save-pass-group">
                                                <button class="btn-save btn-save-pass">L∆∞u thay ƒë·ªïi</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            $(document).ready(function () {
                var ghnEnabled = /*[[${ghnEnabled}]]*/ false;

                // Simple province/district/ward loading
                var provincesCache = [];

                function populateProvinces(data) {
                    var select = document.getElementById('province');
                    select.innerHTML = '<option value="">-- Ch·ªçn t·ªânh --</option>';
                    provincesCache = [];

                    if (!data || !Array.isArray(data)) {
                        console.error('Invalid provinces data:', data);
                        return;
                    }

                    data.forEach(function (p) {
                        var id = p.province_id || p.ProvinceID;
                        var name = p.province_name || p.ProvinceName;
                        if (id && name) {
                            var opt = document.createElement('option');
                            opt.value = id;
                            opt.textContent = name;
                            select.appendChild(opt);
                            provincesCache.push({ id: id, name: name });
                        }
                    });

                    console.log('Populated ' + (data.length || 0) + ' provinces');
                }

                // Centralized function to open the add-address modal (also used as onclick fallback)
                window.openAddAddressModal = function () {
                    console.log('openAddAddressModal invoked');
                    // Reset form
                    $('#street').val('');
                    $('#latitude').val('');
                    $('#longitude').val('');
                    $('#province').val('');
                    $('#district').val('');
                    $('#ward').val('');
                    // Show modal
                    $('#add-address-modal').css('display', 'block');
                    // Load provinces
                    console.log('Loading provinces from API...');
                    $.ajax({
                        url: '/api/shipping/vapi/provinces',
                        type: 'GET',
                        dataType: 'json',
                        timeout: 10000,
                        success: function (data) {
                            console.log('Got provinces:', Array.isArray(data) ? data.length : '(not array)', data);
                            populateProvinces(data);
                        },
                        error: function (xhr, status, error) {
                            console.error('Failed to load provinces:', status, error);
                            alert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch t·ªânh. Vui l√≤ng th·ª≠ l·∫°i.');
                        }
                    });
                };

                // Bind click handler (still present for normal flow)
                $('#add-address').on('click', function () {
                    openAddAddressModal();
                });

                // Clear districts when province changes
                $('#province').on('change', function () {
                    var provinceId = $(this).val();
                    $('#district').val('');
                    $('#ward').val('');
                    $('#district').html('<option value="">-- Ch·ªçn huy·ªán --</option>');
                    $('#ward').html('<option value="">-- Ch·ªçn x√£ --</option>');
                    console.log('Province changed to:', provinceId);

                    if (provinceId) {
                        // Load districts for selected province
                        $.ajax({
                            url: '/api/shipping/districts-list',
                            type: 'GET',
                            data: { provinceId: provinceId },
                            dataType: 'json',
                            success: function (data) {
                                console.log('Districts loaded:', data);
                                var select = document.getElementById('district');
                                select.innerHTML = '<option value="">-- Ch·ªçn huy·ªán --</option>';
                                if (data && Array.isArray(data)) {
                                    data.forEach(function (d) {
                                        var opt = document.createElement('option');
                                        opt.value = d.district_id;
                                        opt.textContent = d.district_name;
                                        select.appendChild(opt);
                                    });
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error('Failed to load districts:', error);
                            }
                        });
                    }
                });

                // Load wards when district changes
                $('#district').on('change', function () {
                    var districtId = $(this).val();
                    $('#ward').val('');
                    $('#ward').html('<option value="">-- Ch·ªçn x√£ --</option>');
                    console.log('District changed to:', districtId);

                    if (districtId) {
                        // Load wards for selected district
                        $.ajax({
                            url: '/api/shipping/wards-list',
                            type: 'GET',
                            data: { districtId: districtId },
                            dataType: 'json',
                            success: function (data) {
                                console.log('Wards loaded:', data);
                                var select = document.getElementById('ward');
                                select.innerHTML = '<option value="">-- Ch·ªçn x√£ --</option>';
                                if (data && Array.isArray(data)) {
                                    data.forEach(function (w) {
                                        var opt = document.createElement('option');
                                        opt.value = w.ward_id;
                                        opt.textContent = w.ward_name;
                                        select.appendChild(opt);
                                    });
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error('Failed to load wards:', error);
                            }
                        });
                    }
                });

                // Close modal
                $('#closeModal, .close').on('click', function () {
                    $('#add-address-modal').css('display', 'none');
                });

                // Also close when clicking outside the modal
                $(window).on('click', function (event) {
                    var modal = $('#add-address-modal');
                    if (event.target == modal[0]) {
                        modal.css('display', 'none');
                    }
                });

                // Save address
                $('#save-address-btn').on('click', function () {
                    var street = $('#street').val().trim();
                    var province = $('#province').val();
                    var lat = $('#latitude').val();
                    var lng = $('#longitude').val();

                    // Basic client-side validation
                    if (!street) {
                        alert('Vui l√≤ng nh·∫≠p s·ªë nh√† / t√™n ƒë∆∞·ªùng');
                        return;
                    }
                    if (!province) {
                        alert('Vui l√≤ng ch·ªçn t·ªânh / th√†nh ph·ªë');
                        return;
                    }

                    var addressData = {
                        address: street,
                        provinceId: province,
                        districtId: $('#district').val() || null,
                        wardCode: $('#ward').val() || null,
                        latitude: lat ? parseFloat(lat) : null,
                        longitude: lng ? parseFloat(lng) : null
                    };

                    console.log('Saving address:', addressData);

                    $.ajax({
                        type: 'POST',
                        url: '/api/public/addressShipping',
                        contentType: 'application/json; charset=utf-8',
                        dataType: 'json',
                        data: JSON.stringify(addressData),
                        success: function (response) {
                            console.log('Address saved successfully:', response);
                            alert('ƒê·ªãa ch·ªâ ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!');
                            $('#add-address-modal').css('display', 'none');
                            // Reload to show new address in list
                            setTimeout(function () { window.location.reload(); }, 500);
                        },
                        error: function (xhr, status, error) {
                            console.error('Failed to save address:', status, error, xhr.responseText);
                            alert('L·ªói khi l∆∞u ƒë·ªãa ch·ªâ: ' + (xhr.responseJSON?.message || error || 'Unknown error'));
                        }
                    });
                });

                // Profile form validator
                Validator({
                    form: '#profile-form',
                    formGroupSelector: '.form-group',
                    errorSelector: '.error',
                    rules: [
                        Validator.isRequired('#phoneNumber', 'Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i'),
                        Validator.isRequired('#name', 'Vui l√≤ng nh·∫≠p h·ªç t√™n'),
                        Validator.minLength('#name', 2),
                        Validator.maxLength('#name', 50),
                        Validator.maxLength('#phoneNumber', 12),
                        Validator.minLength('#phoneNumber', 10),
                    ],
                })

                // Change password validator
                Validator({
                    form: '#change-password-form',
                    formGroupSelector: '.form-group',
                    errorSelector: '.error',
                    rules: [
                        Validator.isRequired('#currentPassword', 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i'),
                        Validator.minLength('#currentPassword', 6),
                        Validator.isRequired('#newPassword', 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi'),
                        Validator.minLength('#newPassword', 6),
                        Validator.maxLength('#newPassword', 50),
                        Validator.isRequired('#confirmPassword', 'Vui l√≤ng nh·∫≠p nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi'),
                        Validator.maxLength('#confirmPassword', 50),
                        Validator.minLength('#confirmPassword', 6),
                        Validator.isConfirmed('#confirmPassword', () => {
                            return document.querySelector('#change-password-form #newPassword').value;
                        }, 'M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng ch√≠nh x√°c'),
                    ],
                })

                // Tab switching
                const tabs = document.querySelectorAll(".tab-item")
                const panes = document.querySelectorAll(".tab-pane")
                const tabActive = document.querySelector(".tab-item.active")
                const line = document.querySelector(".tab-bills .line")

                if (line && tabActive) {
                    line.style.left = tabActive.offsetLeft + "px";
                    line.style.width = tabActive.offsetWidth + "px";
                }

                tabs.forEach((tab, index) => {
                    const pane = panes[index];
                    if (tab instanceof HTMLElement) {
                        tab.onclick = function () {
                            document.querySelector(".tab-item.active")?.classList.remove("active");
                            document.querySelector(".tab-pane.active")?.classList.remove("active");
                            if (line) {
                                line.style.left = tab.offsetLeft + "px";
                                line.style.width = tab.offsetWidth + "px";
                            }
                            tab.classList.add("active");
                            pane.classList.add("active");
                        };
                    }
                })

                // Only number input for phone
                $("#phoneNumber").on('keypress', function (e) {
                    const key = e.key;
                    if (!/[\d\b]/.test(key)) {
                        e.preventDefault();
                    }
                });

                // Delete address handler
                $(document).on('click', '.delete-address-btn', function () {
                    const id = $(this).attr('address-id')
                    $.ajax({
                        type: 'DELETE',
                        contentType: "application/json; charset=utf-8",
                        url: `api/deleteAddress/${id}`,
                        success: function (data) {
                            window.location.reload()
                        }
                    })
                })

                // Edit address handler
                $(document).on('click', '.edit-address-btn', function () {
                    const wrapper = $(this).closest('[data-id]');
                    const addressId = wrapper.data('id');
                    const innerSpan = wrapper.find('span > span').first();
                    const streetText = innerSpan.length ? innerSpan.text().trim() : wrapper.find('span').first().text().trim();

                    $('#street').val(streetText);
                    $('#latitude').val(wrapper.data('lat') || '');
                    $('#longitude').val(wrapper.data('lng') || '');

                    // Load provinces and select the saved one
                    console.log('Edit address:', addressId, streetText);
                    $.ajax({
                        url: '/api/shipping/vapi/provinces',
                        type: 'GET',
                        dataType: 'json',
                        success: function (data) {
                            populateProvinces(data);
                            $('#province').val(wrapper.data('province') || '');
                            $('#add-address-modal').show();
                        },
                        error: function () {
                            alert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch t·ªânh');
                        }
                    });
                });

                // Map picker
                $('#pick-map-btn').on('click', function () {
                    const lat = parseFloat($('#latitude').val()) || null;
                    const lng = parseFloat($('#longitude').val()) || null;
                    try {
                        window.openAddressMapPicker(lat, lng, function (pos) {
                            if (!pos) return;
                            $('#latitude').val(pos.lat);
                            $('#longitude').val(pos.lng);
                        });
                    } catch (err) {
                        console.warn('Map initialization failed', err);
                        alert('Kh√¥ng th·ªÉ m·ªü b·∫£n ƒë·ªì ‚Äî ki·ªÉm tra c·∫•u h√¨nh API Key.');
                    }
                });
            });
        </script>
        <script th:if="${mapsApiKey != null and mapsApiKey != ''}"
            th:src="@{'https://maps.googleapis.com/maps/api/js?key=' + ${mapsApiKey}}" async defer></script>
        <script th:src="@{/js/address-map-picker.js}"></script>
    </div>
</body>

</html>