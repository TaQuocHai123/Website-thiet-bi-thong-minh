<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{user/layout-user.html}">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="d-flex flex-column w-100" style="background-color: rgb(249, 249, 249);  height: 100vh;">
            <div class="container mt-4">
                <div class="d-flex justify-content-center bg-white"
                    style="box-shadow: rgba(149, 157, 165, 0.2) 0px 8px 24px;">
                    <div class="page-right">
                        <h2 class="text-center font-weight-bold" style="font-size: 30px">KẾT QUẢ THANH TOÁN</h2>
                        <div class="mt-5">
                            <div class="text-center mb-4">
                                <span class="text-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 15 15">
                                        <path fill="green" fill-rule="evenodd"
                                            d="M0 7.5a7.5 7.5 0 1 1 15 0a7.5 7.5 0 0 1-15 0Zm7.072 3.21l4.318-5.398l-.78-.624l-3.682 4.601L4.32 7.116l-.64.768l3.392 2.827Z"
                                            clip-rule="evenodd" />
                                    </svg>

                                </span><br>
                                <span class="text-center font-weight-bold text-success" th:text="${status}">

                                </span>
                            </div>
                            <div th:if="${vnpResponseCode == '71'}" class="alert alert-danger" style="padding: 12px;">
                                <p class="font-weight-bold">Lý do: Website chưa được VNPay phê duyệt (mã lỗi 71).</p>
                                <p th:text="${vnpFriendlyMessage}"></p>
                                <p>Hỗ trợ: <a th:href="'mailto:' + ${vnpSupportEmail}" th:text="${vnpSupportEmail}"></a>
                                </p>
                            </div>
                            <div th:if="${status == 'Invalid checksum'}" class="alert alert-warning"
                                style="padding: 12px;">
                                <p class="font-weight-bold">Kiểm tra chữ ký (checksum) không hợp lệ.</p>
                                <p>Hãy kiểm tra lại cấu hình TMN/Secret key trong trang quản trị và liên hệ bộ phận kỹ
                                    thuật nếu cần hỗ trợ.</p>
                            </div>
                            <div th:if="${vnpFriendlyMessage != ''}" class="alert alert-info" style="padding: 12px;">
                                <p th:text="${vnpFriendlyMessage}"></p>
                                <p>Hỗ trợ: <a th:href="'mailto:' + ${vnpSupportEmail}" th:text="${vnpSupportEmail}"></a>
                                </p>
                                <div sec:authorize="hasRole('ADMIN')">
                                    <p><strong>Admin tools:</strong> <a th:href="@{/admin/vnpay-check}">Kiểm tra
                                            VNPay</a></p>
                                </div>
                            </div>
                            <table class="table table-borderless">
                                <tr>
                                    <th>Mã giao dịch của bạn là:</th>
                                    <td class="text-success font-weight-bold" th:text="${result.txnRef}"></td>
                                </tr>
                                <!-- <tr>
                              <th>Số hóa đơn:</th>
                              <td>{{orderId}}</td>
                            </tr> -->
                                <tr>
                                    <th>Số tiền thanh toán:</th>
                                    <td class="font-weight-bold"
                                        th:text="${#numbers.formatDecimal(result.amount, 0, 'COMMA', 0, 'POINT')} + ' VND'">
                                    </td>
                                </tr>

                                <tr>
                                    <th>Ngân hàng: </th>
                                    <td th:text="${result.bankCode}"></td>
                                </tr>
                                <tr>
                                    <th>Ngày giao dịch: </th>
                                    <td
                                        th:text="${#temporals.format(#temporals.createDateTime(result.datePay, 'yyyyMMddHHmmss'), 'dd-MM-yyyy HH:mm:ss')}">
                                    </td>
                                </tr>

                            </table>
                            <!-- Retry payment UI -->
                            <input type="hidden" id="retryAmount" th:value="${result.amount}" />
                            <div class="mt-3">
                                <button id="retryPaymentBtn" class="btn btn-warning" th:if="${!paymentSuccess}">Thử lại
                                    thanh toán</button>
                                <button id="contactSupportBtn" class="btn btn-secondary" th:if="${!paymentSuccess}">Liên
                                    hệ hỗ trợ</button>
                                <div id="retryStatus" style="margin-top:10px; display:none"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" th:inline="javascript"></script>
        <script th:inline="javascript">
            var paymentSuccess = /*[[${paymentSuccess}]]*/ '';
            var orderId = /*[[${orderId}]]*/ '';

            if (paymentSuccess) {
                try { sessionStorage.removeItem('orderTemp'); } catch (e) { }
            }

            $(document).ready(function () {
                $('#retryPaymentBtn').on('click', function (evt) {
                    evt.preventDefault();
                    var btn = $(this);
                    var amount = $('#retryAmount').val();
                    if (!amount || isNaN(amount)) {
                        $('#retryStatus').show().text('Không xác định số tiền thanh toán để thử lại.');
                        return;
                    }
                    btn.prop('disabled', true).text('Đang chuyển đến cổng thanh toán...');
                    $('#retryStatus').hide().text('');

                    $.ajax({
                        type: 'POST',
                        url: '/api/payment',
                        data: { amount: amount },
                        success: function (data) {
                            if (data && data.url) {
                                // Redirect to VNPay payment page
                                window.location.href = data.url;
                            } else {
                                $('#retryStatus').show().text('Không thể tạo giao dịch, vui lòng thử lại sau.');
                                btn.prop('disabled', false).text('Thử lại thanh toán');
                            }
                        },
                        error: function (xhr, status, error) {
                            var message = 'Lỗi khi tạo giao dịch: ' + (xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : status + ' ' + error);
                            $('#retryStatus').show().text(message);
                            btn.prop('disabled', false).text('Thử lại thanh toán');
                        }
                    });
                });

                $('#contactSupportBtn').on('click', function (evt) {
                    window.location.href = 'mailto:' + /*[[${vnpSupportEmail}]]*/ 'hotrovnpay@vnpay.vn';
                });
            });
        </script>
    </div>

</body>

</html>